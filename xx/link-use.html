

app.get("/pay-wait/:noteId", async (req, res) => {
  const { noteId } = req.params;
  const ourRef = `PC-${noteId}-${Date.now()}`;
  await pool.query(
    `INSERT INTO single_purchases (note_id, payment_ref)
     VALUES ($1,$2)`,
    [noteId, ourRef]
  );
  const payUrl = `https://pay.paychangu.com/SC-eHfXFc?reference=${ourRef}`;
  res.send(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Complete Payment</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <style>
        body { font-family: sans-serif; padding: 24px; text-align: center; }
        .btn { background: #e74c3c; color: white; padding: 15px 30px; 
               text-decoration: none; border-radius: 5px; display: inline-block; 
               margin: 20px 0; font-size: 18px; font-weight: bold; }
        .status { margin-top: 30px; color: #2563eb; /* calm blue */ }

        .checking { display: none; }
      </style>
    </head>
    <body>
      <h2>Complete Payment</h2>
      <a href="${payUrl}" target="_blank" class="btn" onclick="startChecking()">
        Pay Now (MWK 700)
      </a>
      
      <div class="status">
        <p id="status-text">After payment, return to this page. Your PDF will open here automatically.</p>
      </div>
      
      <script>
        let checkInterval;
        let attempts = 0;
        
        function startChecking() {
          document.getElementById('status-text').textContent = 'Waiting for payment confirmation...';
          
          checkInterval = setInterval(async () => {
            attempts++;
            try {
              const res = await fetch('/check-payment/${noteId}?ref=${ourRef}');
              const data = await res.json();
              
              if (data.paid) {
                clearInterval(checkInterval);
                document.getElementById('status-text').textContent = 'Payment confirmed! Redirecting...';
                setTimeout(() => {
                  window.location.href = '/unlock/${noteId}?ref=${ourRef}';
                }, 1000);
              } else if (attempts > 60) {
                clearInterval(checkInterval);
                document.getElementById('status-text').innerHTML = 
                  'Taking longer than expected. <a href="/unlock/${noteId}?ref=${ourRef}">Click here to continue</a>';
              }
            } catch (e) {
              console.error(e);
            }
          }, 3000);
        }
      </script>
    </body>
    </html>
  `);
});

app.get("/check-payment/:noteId", async (req, res) => {
  const { noteId } = req.params;
  const { ref } = req.query;
  
  const { rows } = await pool.query(
    `SELECT paid FROM single_purchases 
     WHERE note_id = $1 AND payment_ref = $2`,
    [noteId, ref]
  );
  
  res.json({ paid: rows[0]?.paid || false });
});


// callback


app.post(
  "/api/pay/callback",
  express.raw({ type: "application/json" }),
  async (req, res) => {

    const sig = req.headers["signature"];
    const payload = req.body.toString();

    const expectedSig = crypto
      .createHmac("sha256", process.env.PAYCHANGU_WEBHOOK_SECRET)
      .update(payload)
      .digest("hex");

    if (sig !== expectedSig) return res.sendStatus(403);

    const { status, reference } = JSON.parse(payload);

    if (status !== "success" && status !== "SUCCESS")
      return res.sendStatus(200);

    // âœ… link webhook to latest unpaid purchase
    await pool.query(
      `UPDATE single_purchases
       SET paid = true,
           paid_at = NOW(),
           paychangu_ref = $1
       WHERE id = (
         SELECT id
         FROM single_purchases
         WHERE paid = false
         ORDER BY created_at DESC
         LIMIT 1
       )`,
      [reference]
    );

    res.sendStatus(200);
  }
);


// unlock 
  
  app.get("/unlock/:noteId", async (req, res) => {
  const { noteId } = req.params;
  const { ref } = req.query;

  const { rows } = await pool.query(
    `SELECT n.pdf_url
     FROM single_purchases sp
     JOIN notes n ON n.id = sp.note_id
     WHERE sp.note_id = $1
       AND sp.payment_ref = $2
       AND sp.paid = true`,
    [noteId, ref]
  );

  if (!rows.length) {
    return res.send("Verifying paymentâ€¦ refresh in 5s");
  }

  // ðŸ”‘ change is ONLY here
  res.redirect(`https://study.wtec1.com${rows[0].pdf_url}`);
});
