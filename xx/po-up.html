



// pay to view and buy

app.get("/pay-wait/:noteId", async (req, res) => {
  const { noteId } = req.params;
  const ourRef = `PC-${noteId}-${Date.now()}`;
  const publicKey = process.env.PUBLIC_KEY;

  await pool.query(
    `INSERT INTO single_purchases (note_id, payment_ref)
     VALUES ($1,$2)`,
    [noteId, ourRef]
  );

  res.send(`
<!DOCTYPE html>
<html>
<head>
  <title>Complete Payment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://in.paychangu.com/js/popup.js"></script>

  <style>
    body { font-family: sans-serif; padding: 24px; text-align: center; }
    .btn { background:#2563eb;color:#fff;padding:15px 30px;
           border-radius:6px;font-size:18px;font-weight:bold;border:none; }
    .status { margin-top:20px;color:#2563eb }
  </style>
</head>
<body>

  <h2>Complete Payment</h2>

  <!-- REQUIRED FOR PAYCHANGU POPUP -->
  <div id="wrapper"></div>

  <button class="btn" onclick="makePayment()">Pay Now (MWK 700)</button>

  <div class="status">
    <p id="status-text">Waiting for payment…</p>
  </div>

<script>
const PAYCHANGU_PUBLIC_KEY = "${publicKey}";
const PAYMENT_REF = "${ourRef}";
const NOTE_ID = "${noteId}";

let checkInterval;

function makePayment() {
  PaychanguCheckout({
    public_key: PAYCHANGU_PUBLIC_KEY,
    tx_ref: PAYMENT_REF,
    amount: 100,
    currency: "MWK",
    callback_url: "https://study.wtec1.com/api/pay/callback",
     return_url: "https://study.wtec1.com/pay-wait/" + NOTE_ID,
     
    customer: {
      email: "customer@example.com"
    },
    customization: {
      title: "Book Purchase",
      description: "Premium PDF"
    }
  });

  startChecking();
}

function startChecking() {
  if (checkInterval) return;

  checkInterval = setInterval(async () => {
    const res = await fetch(\`/check-payment/\${NOTE_ID}?ref=\${PAYMENT_REF}\`);
    const data = await res.json();

    if (data.paid) {
      clearInterval(checkInterval);
      window.location.href = \`/unlock/\${NOTE_ID}?ref=\${PAYMENT_REF}\`;
    }
  }, 3000);
}
</script>

</body>
</html>
`);
});


app.get("/check-payment/:noteId", async (req, res) => {
  const { noteId } = req.params;
  const { ref } = req.query;
  
  const { rows } = await pool.query(
    `SELECT paid FROM single_purchases 
     WHERE note_id = $1 AND payment_ref = $2`,
    [noteId, ref]
  );
  
  res.json({ paid: rows[0]?.paid || false });
});


// callback


app.post(
  "/api/pay/callback",
  express.raw({ type: "application/json" }),
  async (req, res) => {

    const sig = req.headers["signature"];
    const payload = req.body.toString();

    const expectedSig = crypto
      .createHmac("sha256", process.env.PAYCHANGU_WEBHOOK_SECRET)
      .update(payload)
      .digest("hex");

    if (sig !== expectedSig) return res.sendStatus(403);

    const { status, reference } = JSON.parse(payload);

    if (status !== "success" && status !== "SUCCESS")
      return res.sendStatus(200);

    await pool.query(
      `UPDATE single_purchases
       SET paid = true,
           paid_at = NOW(),
           paychangu_ref = $1
       WHERE payment_ref = $1`,
      [reference]
    );

    res.sendStatus(200);
  }
);


// unlock 
  
  app.get("/unlock/:noteId", async (req, res) => {
  const { noteId } = req.params;
  const { ref } = req.query;

  const { rows } = await pool.query(
    `SELECT n.pdf_url
     FROM single_purchases sp
     JOIN notes n ON n.id = sp.note_id
     WHERE sp.note_id = $1
       AND sp.payment_ref = $2
       AND sp.paid = true`,
    [noteId, ref]
  );

  if (!rows.length) {
    return res.send("Verifying paymentâ€¦ refresh in 5s");
  }

  // ðŸ”‘ change is ONLY here
  res.redirect(`https://study.wtec1.com${rows[0].pdf_url}`);
});